---
title: "FBJM Normal"
author: "24141303"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(arm)
library(rjags)
library(JointAI)

# simulation sample size
n <- 1000

norm.data <- function(n) {
  x1 <- rnorm(n, 5, 1)
  x2 <- rnorm(n, 4, sqrt(2))
  x3 <- 1.2*x1 + 0.5*x2 + rnorm(n,0,1)
  x4 <- 0.7*x1 + 2.5*x3 + rnorm(n,0,1)
  x5 <- 3.2*x2 - 0.8*x3 + rnorm(n,0,1)
  x6 <- 0.5*x1 + 1.6*x5 + rnorm(n,0,1)
  x7 <- -1.5*x4 - 0.4*x6 + rnorm(n,0,1)
  x8 <- 0.6*x3 + 1.3*x5 + rnorm(n,0,1)
  x9 <- 2.5*x6 + x7   + rnorm(n,0,1)
  x10<- 1.8*x8 - 0.9*x9 + rnorm(n,0,1)
  return(data.frame(x1,x2,x3,x4,x5,x6,x7,x8,x9,x10))
}


miss.method <- function(data, method) {
  n <- nrow(data)
  
  if (method == "MCAR") {
    
    # set missing values for x3 to x10
    data$x3[sample(c(TRUE, FALSE), n, replace = TRUE, prob = c(0.3, 0.7))]  <- NA
    data$x4[sample(c(TRUE, FALSE), n, replace = TRUE, prob = c(0.3, 0.7))]  <- NA
    data$x5[sample(c(TRUE, FALSE), n, replace = TRUE, prob = c(0.3, 0.7))]  <- NA
    data$x6[sample(c(TRUE, FALSE), n, replace = TRUE, prob = c(0.3, 0.7))]  <- NA
    data$x7[sample(c(TRUE, FALSE), n, replace = TRUE, prob = c(0.3, 0.7))]  <- NA
    data$x8[sample(c(TRUE, FALSE), n, replace = TRUE, prob = c(0.3, 0.7))]  <- NA
    data$x9[sample(c(TRUE, FALSE), n, replace = TRUE, prob = c(0.3, 0.7))]  <- NA
    data$x10[sample(c(TRUE, FALSE), n, replace = TRUE, prob = c(0.3, 0.7))] <- NA
    
  } else if (method == "MAR") {
    
    p.miss <- invlogit(-2.25 + 0.2 * data$x1 + 0.1 * data$x2)
    
    # set missing values for x3 to x10
    data$x3[runif(n) < p.miss]  <- NA
    data$x4[runif(n) < p.miss]  <- NA
    data$x5[runif(n) < p.miss]  <- NA
    data$x6[runif(n) < p.miss]  <- NA
    data$x7[runif(n) < p.miss]  <- NA
    data$x8[runif(n) < p.miss]  <- NA
    data$x9[runif(n) < p.miss]  <- NA
    data$x10[runif(n) < p.miss] <- NA
  }
  
  return(data)
}


all.coef <- function(miss.data, aux.ind) {
  
  all.x <- c("x3", "x4", "x5", "x6", "x7", "x8", "x9", "x10")
  
  coef.list <- list(c("x1 + x2"), c("x1 + x3"), c("x2 + x3"), c("x1 + x5"),
                    c("x4 + x6"), c("x3 + x5"), c("x6 + x7"), c("x8 + x9"))
  
  if (aux.ind == "Full") {
    
    aux.list <- list(c("x4 + x5 + x6 + x7 + x8 + x9 + x10"), 
                     c("x2 + x5 + x6 + x7 + x8 + x9 + x10"), 
                     c("x1 + x4 + x6 + x7 + x8 + x9 + x10"), 
                     c("x2 + x3 + x4 + x7 + x8 + x9 + x10"), 
                     c("x1 + x2 + x3 + x5 + x8 + x9 + x10"), 
                     c("x1 + x2 + x4 + x6 + x7 + x9 + x10"), 
                     c("x1 + x2 + x3 + x4 + x5 + x8 + x10"), 
                     c("x1 + x2 + x3 + x4 + x5 + x6 + x7"))
    
  } else {
    
    aux.list <- list(c(0), 
                     c("x2"), 
                     c("x1 + x4"), 
                     c("x2 + x3 + x4"), 
                     c("x1 + x2 + x3 + x5"), 
                     c("x1 + x2 + x4 + x6 + x7"), 
                     c("x1 + x2 + x3 + x4 + x5 + x8"), 
                     c("x1 + x2 + x3 + x4 + x5 + x6 + x7"))
  }
  
  
  all.inferences <- data.frame(
    x = all.x,
    mean.value = rep(0, length(all.x)),
    mean.CI.low = rep(0, length(all.x)),
    mean.CI.up = rep(0, length(all.x)),
    mean.var = rep(0, length(all.x)),
    beta0 = rep(0, length(all.x)),
    beta0.CI.low = rep(0, length(all.x)),
    beta0.CI.up = rep(0, length(all.x)),
    beta0.var = rep(0, length(all.x)),
    beta1 = rep(0, length(all.x)),
    beta1.CI.low = rep(0, length(all.x)),
    beta1.CI.up = rep(0, length(all.x)),
    beta1.var = rep(0, length(all.x)),
    beta2 = rep(0, length(all.x)),
    beta2.CI.low = rep(0, length(all.x)),
    beta2.CI.up = rep(0, length(all.x)),
    beta2.var = rep(0, length(all.x))
  )
  
  for (i in 1:8) {
    
    mean.model <- lm_imp(as.formula(paste(all.x[i], "~ x1 + x2")),
                          data = miss.data, auxvars = NULL, 
                          n.chains = 2, n.adapt  = 1000, n.iter = 3000, thin = 1,
                          seed = i, mess = FALSE)
      
    beta.matrix <- as.matrix(mean.model$MCMC)[, c(1,2,3)]
    x.matrix <- c(1, 5, 4)
    mu <- as.numeric(beta.matrix %*% x.matrix)
      
    all.inferences$mean.value[i] = mean(mu)
    all.inferences$mean.CI.low[i] = quantile(mu, 0.025)
    all.inferences$mean.CI.up[i] = quantile(mu, 0.975)
    all.inferences$mean.var[i] = var(mu)
    
    # estimate beta0, beta1, beta2
    fit.model <- lm_imp(as.formula(paste(all.x[i], "~", paste(coef.list[[i]]))),
                        data = miss.data, auxvars = as.formula(paste("~", paste(aux.list[[i]]))), 
                        n.chains = 2, n.adapt  = 1000, n.iter = 3000, thin = 1,
                        seed = i, mess = FALSE)
    
    coef.summary <- summary(fit.model)$res[[all.x[i]]]$regcoef
    
    all.inferences$beta0[i] = coef.summary[1, 1]
    all.inferences$beta0.CI.low[i] = coef.summary[1, 3]
    all.inferences$beta0.CI.up[i] = coef.summary[1, 4]
    all.inferences$beta0.var[i] = coef.summary[1, 2]^2
    all.inferences$beta1[i] = coef.summary[2, 1]
    all.inferences$beta1.CI.low[i] = coef.summary[2, 3]
    all.inferences$beta1.CI.up[i] = coef.summary[2, 4]
    all.inferences$beta1.var[i] = coef.summary[2, 2]^2
    all.inferences$beta2[i] = coef.summary[3, 1]
    all.inferences$beta2.CI.low[i] = coef.summary[3, 3]
    all.inferences$beta2.CI.up[i] = coef.summary[3, 4]
    all.inferences$beta2.var[i] = coef.summary[3, 2]^2
    
  }
  
  return(all.inferences)
}


# iteration

full.bayes <- function(n, miss, iterate, aux.type) {
  
  output <- matrix(0, nrow = 32, ncol = 5)
  
  rownames(output) <- c("x3.mean","x3.beta0", "x3.beta1","x3.beta2",
                        "x4.mean","x4.beta0", "x4.beta1","x4.beta2",
                        "x5.mean","x5.beta0", "x5.beta1","x5.beta2",
                        "x6.mean","x6.beta0", "x6.beta1","x6.beta2",
                        "x7.mean","x7.beta0", "x7.beta1","x7.beta2",
                        "x8.mean","x8.beta0", "x8.beta1","x8.beta2",
                        "x9.mean","x9.beta0", "x9.beta1","x9.beta2",
                        "x10.mean","x10.beta0", "x10.beta1","x10.beta2")
  
  colnames(output) <- c("Count","Emp.Var", "Ave.Var", "Var.Ratio","Bias")
  
  mu.beta <- matrix(0, nrow = 32, ncol = iterate)
  all.var <- matrix(0, nrow = 32, ncol = iterate)
  
  true.value <- matrix(c(8, 0, 1.2, 0.5, 23.5, 0, 0.7, 2.5,
                         6.4, 0, 3.2, -0.8, 12.74, 0, 0.5, 1.6,
                         -40.346, 0, -1.5, -0.4, 13.12, 0, 0.6, 1.3,
                         -8.496, 0, 2.5, 1, 31.2624, 0, 1.8, -0.9), 
                       nrow = 32, ncol = 1, byrow = TRUE)
  
  for (i in 1:iterate) {
    
    data <- norm.data(n)
    
    if (miss == "MCAR") {
      miss.data <- miss.method(data, "MCAR")
    } else if (miss == "MAR") {
      miss.data <- miss.method(data, "MAR")
    }
    
    result <- all.coef(miss.data, aux.type)
    
    for (k in seq(from = 4, to = 32, by = 4)) {
      
      mu.beta[k-3, i] = result$mean.value[k/4]
      mu.beta[k-2, i] = result$beta0[k/4]
      mu.beta[k-1, i] = result$beta1[k/4]
      mu.beta[k, i] = result$beta2[k/4]
      
      all.var[k-3, i] = result$mean.var[k/4]
      all.var[k-2, i] = result$beta0.var[k/4]
      all.var[k-1, i] = result$beta1.var[k/4]
      all.var[k, i] = result$beta2.var[k/4]
        
      if (result$mean.CI.up[k/4] >= true.value[k-3]  & 
          result$mean.CI.low[k/4] <= true.value[k-3]) {
        output[k-3, 1] = output[k-3, 1] + 1
      }
      if (result$beta0.CI.up[k/4] >= true.value[k-2]  & 
          result$beta0.CI.low[k/4] <= true.value[k-2]) {
        output[k-2, 1] = output[k-2, 1] + 1
      }
      if (result$beta1.CI.up[k/4] >= true.value[k-1]  & 
          result$beta1.CI.low[k/4] <= true.value[k-1]) {
        output[k-1, 1] = output[k-1, 1] + 1
      }
      if (result$beta2.CI.up[k/4] >= true.value[k]  & 
          result$beta2.CI.low[k/4] <= true.value[k]) {
        output[k, 1] = output[k, 1] + 1
      }
    }
  }
  
  output[, 1] = output[, 1] / iterate
  
  for (i in seq(from = 4, to = 32, by = 4)) {
    for (j in (i-3):i) {
      output[j, 2] = var(mu.beta[j, 1:iterate], na.rm = TRUE)
      
      output[j, 3] = mean(all.var[j, 1:iterate], na.rm = TRUE)
      
      output[j, 4] = mean(all.var[j, 1:iterate], na.rm = TRUE) /
                     var(mu.beta[j, 1:iterate], na.rm = TRUE)

      output[j, 5] = mean(mu.beta[j, 1:iterate], na.rm = TRUE) - true.value[j, 1]
    }
  }
  
  return(output)
}

set.seed(123)
mcar.output <- full.bayes(1000, "MCAR", 50, "Full")

set.seed(123)
mar.output <- full.bayes(1000, "MAR", 50, "Full")

set.seed(123)
mcar.output1 <- full.bayes(1000, "MCAR", 50, "Con")

set.seed(123)
mar.output2 <- full.bayes(1000, "MAR", 50, "Con")


```













